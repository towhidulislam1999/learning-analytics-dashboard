<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Learning Analytics Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://unpkg.com/compromise@latest/builds/compromise.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* Login Page */
    .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
    .login-card {
      background: white; border-radius: 16px; padding: 40px; max-width: 500px; width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .login-header { text-align: center; margin-bottom: 30px; }
    .logo-symbol {
      display: inline-block; width: 80px; height: 80px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; font-size: 40px; line-height: 80px; border-radius: 50%; margin-bottom: 20px;
    }
    .login-title { font-size: 24px; color: #333; margin-bottom: 8px; }
    .login-subtitle { font-size: 16px; color: #666; font-weight: normal; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
    .form-control {
      width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
      font-size: 14px; transition: border 0.3s;
    }
    .form-control:focus { outline: none; border-color: #667eea; }
    .btn {
      padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px;
      font-weight: 600; cursor: pointer; transition: all 0.3s;
    }
    .btn--primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; width: 100%; margin-top: 10px;
    }
    .btn--primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    .demo-accounts { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; }
    .demo-accounts h3 { font-size: 14px; margin-bottom: 10px; color: #666; }
    .demo-account {
      display: block; width: 100%; padding: 8px; margin-bottom: 5px; background: white;
      border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px; text-align: left;
    }
    .demo-account:hover { background: #667eea; color: white; }
    .error-message {
      background: #fee; color: #c33; padding: 10px; border-radius: 6px;
      margin-bottom: 15px; font-size: 13px; display: none;
    }
    .error-message.show { display: block; }

    /* Accordion Styles */
    .instruction-item {
      margin-bottom: 1rem; border: 1px solid #E8E8E8; border-radius: 4px; overflow: hidden;
    }
    .instruction-header {
      background: #FFF; display: flex; align-items: center; padding: 0.75rem 1rem;
      cursor: pointer; user-select: none; outline: none;
    }
    .instruction-header:focus { box-shadow: 0 0 0 3px rgba(220,20,60,0.3); }
    .instruction-icon {
      display: inline-block; width: 1em; transition: transform 0.3s ease; margin-right: 0.5rem;
    }
    .instruction-content {
      max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
      background: #FEFEFE; padding: 0 1rem;
    }
    .instruction-item.open .instruction-content { max-height: 600px; padding: 1rem; }
    .instruction-item.open .instruction-icon { transform: rotate(90deg); }
    .instructions-panel { margin-top: 20px; }
    .instructions-panel h2 { font-size: 16px; margin-bottom: 10px; color: #333; }
    .instruction-title { font-size: 14px; }
    .instruction-content ol, .instruction-content ul { margin-left: 20px; }
    .instruction-content li { margin-bottom: 6px; font-size: 13px; color: #555; }

    /* Dashboard */
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .header {
      background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header-title { font-size: 24px; color: #333; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .lang-switch {
      padding: 8px 16px; background: #f0f0f0; border: none; border-radius: 6px;
      cursor: pointer; font-size: 14px;
    }
    .lang-switch:hover { background: #e0e0e0; }
    .logout-btn {
      padding: 8px 16px; background: #ff4757; color: white; border: none;
      border-radius: 6px; cursor: pointer; font-size: 14px;
    }
    .logout-btn:hover { background: #ff3838; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab {
      padding: 12px 24px; background: white; border: none; border-radius: 8px;
      cursor: pointer; font-size: 14px; font-weight: 500; color: #666; transition: all 0.3s;
    }
    .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card {
      background: white; padding: 24px; border-radius: 12px; margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .card-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #333; }
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px; margin-bottom: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 20px; border-radius: 12px; text-align: center;
    }
    .stat-value { font-size: 32px; font-weight: bold; margin-bottom: 8px; }
    .stat-label { font-size: 14px; opacity: 0.9; }
    .upload-area {
      border: 2px dashed #ddd; border-radius: 12px; padding: 40px; text-align: center;
      cursor: pointer; transition: all 0.3s;
    }
    .upload-area:hover { border-color: #667eea; background: #f8f9ff; }
    .upload-area.dragover { border-color: #667eea; background: #f0f3ff; }
    .file-input { display: none; }
    .file-list { margin-top: 20px; }
    .file-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px; background: #f5f5f5; border-radius: 8px; margin-bottom: 8px;
    }
    .file-info { display: flex; align-items: center; gap: 10px; }
    .delete-btn {
      padding: 6px 12px; background: #ff4757; color: white; border: none;
      border-radius: 4px; cursor: pointer; font-size: 12px;
    }
    .delete-btn:hover { background: #ff3838; }
    .student-list { max-height: 400px; overflow-y: auto; }
    .student-item {
      padding: 12px; background: #f8f8f8; border-radius: 8px; margin-bottom: 8px;
      cursor: pointer; transition: all 0.3s;
    }
    .student-item:hover { background: #e8e8e8; transform: translateX(4px); }
    .student-name { font-weight: 600; color: #333; margin-bottom: 4px; }
    .student-stats { display: flex; gap: 15px; font-size: 13px; color: #666; }
    .analysis-section { margin-top: 20px; }
    .analysis-item {
      padding: 15px; background: #f9f9f9; border-left: 4px solid #667eea;
      border-radius: 4px; margin-bottom: 12px;
    }
    .analysis-label { font-weight: 600; color: #333; margin-bottom: 6px; }
    .analysis-value { color: #666; font-size: 14px; }
    .chart-container { position: relative; height: 300px; margin-top: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <span class="logo-symbol">学</span>
        <h1 class="login-title" data-ja="学習分析ダッシュボード" data-en="Learning Analytics Dashboard">Learning Analytics Dashboard</h1>
        <h2 class="login-subtitle" data-ja="リフレクティブライティング分析" data-en="Reflective Writing Analysis">Reflective Writing Analysis</h2>
      </div>
      <form id="loginForm" onsubmit="return false;">
        <div class="form-group">
          <label class="form-label" data-ja="教員ID / Teacher ID" data-en="Teacher ID">Teacher ID</label>
          <input type="text" id="username" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label" data-ja="パスワード / Password" data-en="Password">Password</label>
          <input type="password" id="password" class="form-control" required>
        </div>
        <div id="loginError" class="error-message"></div>
        <button type="button" id="loginBtn" class="btn btn--primary" data-ja="ログイン / Login" data-en="Login">Login</button>
      </form>
      <div class="demo-accounts">
        <h3 data-ja="デモアカウント / Demo Accounts" data-en="Demo Accounts">Demo Accounts</h3>
        <button class="demo-account" data-user="prof_yamada" data-pass="analytics2025">prof_yamada / analytics2025</button>
        <button class="demo-account" data-user="prof_suzuki" data-pass="learning123">prof_suzuki / learning123</button>
        <button class="demo-account" data-user="prof_tanaka" data-pass="corpus2025">prof_tanaka / corpus2025</button>
      </div>

      <!-- Instructions Accordion -->
      <section class="instructions-panel">
        <h2 data-ja="使用方法 / How to Use" data-en="How to Use">How to Use</h2>
        <div class="instruction-item">
          <div class="instruction-header" role="button" tabindex="0" aria-expanded="false">
            <span class="instruction-icon">▶</span>
            <span class="instruction-title" data-ja="🚀 はじめに" data-en="🚀 Getting Started">🚀 Getting Started</span>
          </div>
          <div class="instruction-content" aria-hidden="true">
            <ol>
              <li data-ja="デモアカウントを選択してください" data-en="Select a demo account above">Select a demo account above</li>
              <li data-ja="ログインボタンを押してください" data-en="Click Login button">Click Login button</li>
              <li data-ja="概要セクションから開始してください" data-en="Start with Overview section">Start with Overview section</li>
            </ol>
          </div>
        </div>
        <div class="instruction-item">
          <div class="instruction-header" role="button" tabindex="0" aria-expanded="false">
            <span class="instruction-icon">▶</span>
            <span class="instruction-title" data-ja="📁 ファイルアップロード" data-en="📁 File Upload">📁 File Upload</span>
          </div>
          <div class="instruction-content" aria-hidden="true">
            <p><strong data-ja="要件:" data-en="Requirements:">Requirements:</strong></p>
            <ul>
              <li data-ja="CSV、DOC、DOCXフォーマット" data-en="CSV, DOC, or DOCX format">CSV, DOC, or DOCX format</li>
              <li data-ja="最大10MB" data-en="Max 10MB">Max 10MB</li>
              <li data-ja="CSV列: student_name, essay" data-en="CSV columns: student_name, essay">CSV columns: student_name, essay</li>
            </ul>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <div class="container">
      <div class="header">
        <h1 class="header-title" data-ja="学習分析ダッシュボード" data-en="Learning Analytics Dashboard">Learning Analytics Dashboard</h1>
        <div class="header-actions">
          <span id="currentUser" style="margin-right: 15px; color: #666;"></span>
          <button id="langSwitch" class="lang-switch">日本語 / English</button>
          <button id="logoutBtn" class="logout-btn" data-ja="ログアウト" data-en="Logout">Logout</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="overview" data-ja="概要" data-en="Overview">Overview</button>
        <button class="tab" data-tab="files" data-ja="ファイル管理" data-en="File Management">File Management</button>
        <button class="tab" data-tab="students" data-ja="学生分析" data-en="Student Analysis">Student Analysis</button>
        <button class="tab" data-tab="nlp" data-ja="NLP分析" data-en="NLP Analysis">NLP Analysis</button>
      </div>

      <!-- Overview Tab -->
      <div id="overview" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalStudents">0</div>
            <div class="stat-label" data-ja="総学生数" data-en="Total Students">Total Students</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalEssays">0</div>
            <div class="stat-label" data-ja="総エッセイ数" data-en="Total Essays">Total Essays</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgWordCount">0</div>
            <div class="stat-label" data-ja="平均単語数" data-en="Avg Word Count">Avg Word Count</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgSentiment">0</div>
            <div class="stat-label" data-ja="平均感情スコア" data-en="Avg Sentiment">Avg Sentiment</div>
          </div>
        </div>
        <div class="card">
          <h2 class="card-title" data-ja="クラス全体のパフォーマンス" data-en="Overall Class Performance">Overall Class Performance</h2>
          <div class="chart-container"><canvas id="overviewChart"></canvas></div>
        </div>
        <div class="card">
          <h2 class="card-title" data-ja="感情分析分布" data-en="Sentiment Distribution">Sentiment Distribution</h2>
          <div class="chart-container"><canvas id="sentimentChart"></canvas></div>
        </div>
      </div>

      <!-- File Management Tab -->
      <div id="files" class="tab-content">
        <div class="card">
          <h2 class="card-title" data-ja="ファイルをアップロード" data-en="Upload Files">Upload Files</h2>
          <div class="upload-area" id="uploadArea">
            <p data-ja="CSV、DOC、DOCXファイルをドラッグ＆ドロップ" data-en="Drag & drop CSV, DOC, or DOCX files here">Drag & drop CSV, DOC, or DOCX files here</p>
            <p>or</p>
            <button class="btn btn--primary" onclick="document.getElementById('fileInput').click()" data-ja="ファイルを選択" data-en="Select File">Select File</button>
            <input type="file" id="fileInput" class="file-input" accept=".csv,.doc,.docx" multiple />          </div>
          <div class="file-list" id="fileList"></div>
        </div>
      </div>

      <!-- Student Analysis Tab -->
      <div id="students" class="tab-content">
        <div class="card">
          <h2 class="card-title" data-ja="学生一覧" data-en="Student List">Student List</h2>
          <div class="student-list" id="studentList"></div>
        </div>
        <div class="card" id="studentDetailCard" style="display: none;">
          <h2 class="card-title" id="studentDetailName"></h2>
          <div class="chart-container"><canvas id="studentChart"></canvas></div>
          <div class="analysis-section" id="studentAnalysis"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    const state = { currentUser: null, language: 'en', files: [], students: [], essays: [] };
    const accounts = { 
      'prof_yamada': 'analytics2025', 
      'prof_suzuki': 'learning123', 
      'prof_tanaka': 'corpus2025' 
    };

    // Wait for DOM to load
    window.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard loaded');
      initAccordion();
      initLogin();
      initDashboard();
      initLanguage();
      initFileUpload();
    });

    // Accordion
    function initAccordion() {
      const items = document.querySelectorAll('.instruction-item');
      if (!items.length) return;
      items.forEach(item => {
        const header = item.querySelector('.instruction-header');
        const content = item.querySelector('.instruction-content');
        if (!header || !content) return;
        header.addEventListener('click', () => toggleAccordion(item, header, content));
        header.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleAccordion(item, header, content);
          }
        });
      });
    }

    function toggleAccordion(item, header, content) {
      try {
        const isOpen = item.classList.toggle('open');
        header.setAttribute('aria-expanded', isOpen);
        content.setAttribute('aria-hidden', !isOpen);
        if (isOpen) content.style.maxHeight = content.scrollHeight + 'px';
        else content.style.maxHeight = '0';
      } catch (err) {
        console.error('Accordion error:', err);
      }
    }

    // Login
    function initLogin() {
      const loginForm = document.getElementById('loginForm');
      const loginBtn = document.getElementById('loginBtn');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const demoButtons = document.querySelectorAll('.demo-account');
      
      console.log('Login initialized', { loginForm, loginBtn, usernameInput, passwordInput });
      
      // Direct button click handler
      if (loginBtn) {
        loginBtn.addEventListener('click', function() {
          console.log('Login button clicked');
          performLogin();
        });
      }
      
      // Also handle form submit (Enter key)
      if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Form submitted');
          performLogin();
          return false;
        });
      }
      
      // Perform login function
      function performLogin() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        
        console.log('Performing login:', { username, password, accounts });
        
        if (accounts[username] && accounts[username] === password) {
          console.log('Login successful!');
          state.currentUser = username;
          showDashboard();
        } else {
          console.log('Login failed - invalid credentials');
          showError('Invalid username or password');
        }
      }
      
      // Demo account buttons
      demoButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const user = btn.getAttribute('data-user');
          const pass = btn.getAttribute('data-pass');
          console.log('Demo clicked:', user, pass);
          usernameInput.value = user;
          passwordInput.value = pass;
        });
      });
    }

    function showError(msg) {
      const error = document.getElementById('loginError');
      if (error) {
        error.textContent = msg;
        error.classList.add('show');
        setTimeout(() => error.classList.remove('show'), 3000);
      }
    }

    function showDashboard() {
      console.log('Showing dashboard');
      const loginPage = document.getElementById('loginPage');
      const dashboard = document.getElementById('dashboard');
      const currentUser = document.getElementById('currentUser');
      
      if (loginPage) loginPage.style.display = 'none';
      if (dashboard) {
        dashboard.style.display = 'block';
        dashboard.classList.add('active');
      }
      if (currentUser) currentUser.textContent = state.currentUser;
      
      updateDashboard();
    }

    // Logout
    function initLogout() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          state.currentUser = null;
          const loginPage = document.getElementById('loginPage');
          const dashboard = document.getElementById('dashboard');
          
          if (loginPage) loginPage.style.display = 'flex';
          if (dashboard) {
            dashboard.style.display = 'none';
            dashboard.classList.remove('active');
          }
          
          document.getElementById('username').value = '';
          document.getElementById('password').value = '';
        });
      }
    }

    // Language
    function initLanguage() {
      const langSwitch = document.getElementById('langSwitch');
      if (langSwitch) {
        langSwitch.addEventListener('click', function() {
          state.language = state.language === 'en' ? 'ja' : 'en';
          updateLanguage();
        });
      }
      initLogout();
    }

    function updateLanguage() {
      document.querySelectorAll('[data-ja][data-en]').forEach(el => {
        el.textContent = el.dataset[state.language];
      });
    }

    // Tabs
    function initDashboard() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });
    }

    // File upload
    function initFileUpload() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');

      if (uploadArea) {
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          handleFiles(e.dataTransfer.files);
        });
      }
      
      if (fileInput) {
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
      }
    }

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        const allowedExt = ['.csv', '.doc', '.docx'];
        const ext = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
        
        if (!allowedExt.includes(ext)) {
          showMessage('CSVまたはDOC/DOCXファイルのみアップロード可能です / Only CSV or DOC/DOCX files allowed', 'error');
          return;
        }
        
        const reader = new FileReader();
        if (ext === '.csv') {
          reader.onload = (e) => parseCSV(e.target.result, file.name, ext);
          reader.readAsText(file);
        } else {
          reader.onload = (e) => parseWordDoc(e.target.result, file.name, ext);
          reader.readAsArrayBuffer(file);
        }
      });
    }
    
    function showMessage(msg, type) {
      const error = document.getElementById('loginError');
      error.textContent = msg;
      error.style.background = type === 'error' ? '#fee' : '#efe';
      error.style.color = type === 'error' ? '#c33' : '#3c3';
      error.classList.add('show');
      setTimeout(() => error.classList.remove('show'), 4000);
    }

    function parseCSV(text, filename, ext) {
      const lines = text.split('\n').filter(line => line.trim());
      const headers = lines[0].split(',').map(h => h.trim());
      const essays = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const essay = {};
        headers.forEach((header, index) => { essay[header] = values[index]; });
        essays.push(essay);
      }
      
      const fileEntry = { 
        name: filename, 
        date: new Date(), 
        essays: essays.length,
        documentType: ext === '.csv' ? 'csv' : 'word'
      };
      
      state.files.push(fileEntry);
      state.essays.push(...essays);
      processStudents();
      updateDashboard();
      displayFiles();
      showMessage(`${filename} uploaded successfully! ${essays.length} essays processed.`, 'success');
    }
    
    function parseWordDoc(arrayBuffer, filename, ext) {
      // Simple Word document parser - extracts text content
      // For production, you'd want to use mammoth.js library
      try {
        const textDecoder = new TextDecoder('utf-8');
        let text = textDecoder.decode(arrayBuffer);
        
        // Basic text extraction (works for simple .doc files)
        // Remove non-printable characters and excessive whitespace
        text = text.replace(/[^\x20-\x7E\n]/g, '').replace(/\s+/g, ' ').trim();
        
        // If text is too short, likely failed to parse properly
        if (text.length < 50) {
          showMessage('Word document parsing limited. Consider converting to CSV for better results.', 'error');
          return;
        }
        
        // Create a single essay entry from the document
        const essay = {
          student_name: filename.replace(/\.(doc|docx)$/i, ''),
          essay: text
        };
        
        const fileEntry = { 
          name: filename, 
          date: new Date(), 
          essays: 1,
          documentType: 'word'
        };
        
        state.files.push(fileEntry);
        state.essays.push(essay);
        processStudents();
        updateDashboard();
        displayFiles();
        showMessage(`${filename} uploaded successfully!`, 'success');
      } catch (err) {
        showMessage('Error parsing Word document. Please convert to CSV format.', 'error');
        console.error('Word parsing error:', err);
      }
    }

    function processStudents() {
      const studentMap = {};
      state.essays.forEach(essay => {
        const name = essay.student_name || essay.name || 'Unknown';
        const text = essay.essay || essay.text || essay.content || '';
        if (!studentMap[name]) {
          studentMap[name] = { name, essays: [], totalWords: 0, avgSentiment: 0, strengths: [], weaknesses: [] };
        }
        const analysis = analyzeText(text);
        studentMap[name].essays.push({ text, analysis });
        studentMap[name].totalWords += analysis.wordCount;
      });
      Object.values(studentMap).forEach(student => {
        const sentiments = student.essays.map(e => e.analysis.sentiment);
        student.avgSentiment = (sentiments.reduce((a, b) => a + b, 0) / sentiments.length).toFixed(2);
        student.avgWords = Math.round(student.totalWords / student.essays.length);
        if (student.avgWords > 200) student.strengths.push('Good essay length');
        else student.weaknesses.push('Short essays');
        if (student.avgSentiment > 0.3) student.strengths.push('Positive tone');
        else if (student.avgSentiment < -0.1) student.weaknesses.push('Negative tone');
      });
      state.students = Object.values(studentMap);
    }

    function analyzeText(text) {
      const words = text.split(/\s+/).filter(w => w.length > 0);
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
      const positive = ['good', 'great', 'excellent', 'happy', 'love', 'wonderful', 'amazing', 'fantastic'];
      const negative = ['bad', 'poor', 'terrible', 'sad', 'hate', 'awful', 'horrible', 'difficult'];
      let sentiment = 0;
      words.forEach(word => {
        const lower = word.toLowerCase();
        if (positive.includes(lower)) sentiment += 0.1;
        if (negative.includes(lower)) sentiment -= 0.1;
      });
      const avgWordLength = words.reduce((sum, w) => sum + w.length, 0) / words.length;
      return {
        wordCount: words.length,
        sentenceCount: sentences.length,
        sentiment: Math.max(-1, Math.min(1, sentiment)),
        complexity: (avgWordLength / 10).toFixed(2),
        avgWordLength: avgWordLength.toFixed(1)
      };
    }

    function displayFiles() {
      const list = document.getElementById('fileList');
      list.innerHTML = '<h3 style="margin-top: 20px; margin-bottom: 10px;">Uploaded Files</h3>';
      state.files.forEach((file, index) => {
        const icon = file.documentType === 'word' ? '📄' : '🗒️';
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `
          <div class="file-info">
            <span class="file-icon" style="font-size: 20px;">${icon}</span>
            <span>${file.name}</span>
            <span style="color: #666;">${file.essays} essay${file.essays > 1 ? 's' : ''}</span>
          </div>
          <button class="delete-btn" onclick="deleteFile(${index})">Delete</button>
        `;
        list.appendChild(item);
      });
    }

    function deleteFile(index) {
      const file = state.files[index];
      state.essays = state.essays.filter((_, i) => i < state.essays.length - file.essays);
      state.files.splice(index, 1);
      processStudents();
      updateDashboard();
      displayFiles();
    }

    function updateDashboard() {
      document.getElementById('totalStudents').textContent = state.students.length;
      document.getElementById('totalEssays').textContent = state.essays.length;
      const totalWords = state.students.reduce((sum, s) => sum + s.totalWords, 0);
      document.getElementById('avgWordCount').textContent = state.students.length > 0 ? Math.round(totalWords / state.essays.length) : 0;
      const avgSent = state.students.reduce((sum, s) => sum + parseFloat(s.avgSentiment), 0) / state.students.length;
      document.getElementById('avgSentiment').textContent = state.students.length > 0 ? avgSent.toFixed(2) : 0;
      updateCharts();
      displayStudents();
      displayNLPResults();
    }

    function updateCharts() {
      const ctx1 = document.getElementById('overviewChart');
      if (ctx1 && state.students.length > 0) {
        const chart1 = Chart.getChart(ctx1);
        if (chart1) chart1.destroy();
        new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: state.students.map(s => s.name),
            datasets: [{
              label: 'Average Word Count',
              data: state.students.map(s => s.avgWords),
              backgroundColor: 'rgba(102, 126, 234, 0.5)',
              borderColor: 'rgba(102, 126, 234, 1)',
              borderWidth: 2
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
      const ctx2 = document.getElementById('sentimentChart');
      if (ctx2 && state.students.length > 0) {
        const chart2 = Chart.getChart(ctx2);
        if (chart2) chart2.destroy();
        const positive = state.students.filter(s => s.avgSentiment > 0.1).length;
        const neutral = state.students.filter(s => s.avgSentiment >= -0.1 && s.avgSentiment <= 0.1).length;
        const negative = state.students.filter(s => s.avgSentiment < -0.1).length;
        new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: ['Positive', 'Neutral', 'Negative'],
            datasets: [{
              data: [positive, neutral, negative],
              backgroundColor: ['#4ade80', '#94a3b8', '#f87171']
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }
    }

    function displayStudents() {
      const list = document.getElementById('studentList');
      list.innerHTML = '';
      state.students.forEach(student => {
        const item = document.createElement('div');
        item.className = 'student-item';
        item.innerHTML = `
          <div class="student-name">${student.name}</div>
          <div class="student-stats">
            <span>📝 ${student.essays.length} essays</span>
            <span>📊 ${student.avgWords} avg words</span>
            <span>😊 ${student.avgSentiment} sentiment</span>
          </div>
        `;
        item.addEventListener('click', () => showStudentDetail(student));
        list.appendChild(item);
      });
    }

    function showStudentDetail(student) {
      const card = document.getElementById('studentDetailCard');
      card.style.display = 'block';
      document.getElementById('studentDetailName').textContent = student.name;
      const ctx = document.getElementById('studentChart');
      if (ctx) {
        const chartInstance = Chart.getChart(ctx);
        if (chartInstance) chartInstance.destroy();
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: student.essays.map((_, i) => `Essay ${i + 1}`),
            datasets: [{
              label: 'Word Count',
              data: student.essays.map(e => e.analysis.wordCount),
              borderColor: 'rgba(102, 126, 234, 1)',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              tension: 0.4
            }, {
              label: 'Sentiment',
              data: student.essays.map(e => e.analysis.sentiment * 100),
              borderColor: 'rgba(118, 75, 162, 1)',
              backgroundColor: 'rgba(118, 75, 162, 0.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
      }
      const analysisDiv = document.getElementById('studentAnalysis');
      analysisDiv.innerHTML = `
        <div class="analysis-item">
          <div class="analysis-label">Strengths</div>
          <div class="analysis-value">${student.strengths.join(', ') || 'Analyzing...'}</div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">Areas for Improvement</div>
          <div class="analysis-value">${student.weaknesses.join(', ') || 'Good overall performance'}</div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">Total Essays Submitted</div>
          <div class="analysis-value">${student.essays.length}</div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">Average Complexity Score</div>
          <div class="analysis-value">${student.essays[0]?.analysis.complexity || 'N/A'}</div>
        </div>
      `;
      card.scrollIntoView({ behavior: 'smooth' });
    }

    function displayNLPResults() {
      const nlpDiv = document.getElementById('nlpResults');
      if (state.essays.length === 0) {
        nlpDiv.innerHTML = '<p style="color: #666;">No data available. Please upload CSV files.</p>';
        return;
      }
      const allAnalyses = state.students.flatMap(s => s.essays.map(e => e.analysis));
      const avgComplexity = (allAnalyses.reduce((sum, a) => sum + parseFloat(a.complexity), 0) / allAnalyses.length).toFixed(2);
      const avgSentences = Math.round(allAnalyses.reduce((sum, a) => sum + a.sentenceCount, 0) / allAnalyses.length);
      const allWords = state.essays.flatMap(e => {
        const text = e.essay || e.text || e.content || '';
        return text.toLowerCase().split(/\s+/).filter(w => w.length > 3);
      });
      const wordFreq = {};
      allWords.forEach(word => { wordFreq[word] = (wordFreq[word] || 0) + 1; });
      const topWords = Object.entries(wordFreq).sort((a, b) => b[1] - a[1]).slice(0, 10);
      nlpDiv.innerHTML = `
        <div class="analysis-item">
          <div class="analysis-label">📊 Average Text Complexity</div>
          <div class="analysis-value">${avgComplexity} (Higher = More complex vocabulary)</div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">📝 Average Sentences per Essay</div>
          <div class="analysis-value">${avgSentences}</div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">💬 Most Common Words</div>
          <div class="analysis-value">${topWords.map(([word, count]) => `${word} (${count})`).join(', ')}</div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">🎯 Class Writing Style</div>
          <div class="analysis-value">
            ${avgComplexity > 0.6 ? 'Advanced vocabulary usage' : avgComplexity > 0.5 ? 'Moderate complexity' : 'Simple, clear writing'}
          </div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">📈 Engagement Level</div>
          <div class="analysis-value">
            ${state.students.filter(s => s.avgSentiment > 0.2).length} students show high engagement,
            ${state.students.filter(s => s.avgSentiment < 0).length} students may need support
          </div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">💡 Recommendations</div>
          <div class="analysis-value">${generateRecommendations()}</div>
        </div>
      `;
    }

    function generateRecommendations() {
      const recommendations = [];
      const shortEssays = state.students.filter(s => s.avgWords < 150).length;
      const lowSentiment = state.students.filter(s => s.avgSentiment < -0.1).length;
      if (shortEssays > state.students.length * 0.3) {
        recommendations.push('Consider encouraging students to expand their essays with more details');
      }
      if (lowSentiment > state.students.length * 0.2) {
        recommendations.push('Some students show negative sentiment - consider one-on-one discussions');
      }
      const highPerformers = state.students.filter(s => s.avgWords > 250 && s.avgSentiment > 0.2).length;
      if (highPerformers > 0) {
        recommendations.push(`${highPerformers} student(s) showing excellent performance - recognize their effort`);
      }
      if (recommendations.length === 0) {
        recommendations.push('Overall class performance is balanced. Continue current teaching approach.');
      }
      return recommendations.join(' • ');
    }

    window.deleteFile = deleteFile;
  </script>
</body>
</html>
